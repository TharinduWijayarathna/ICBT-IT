on:
  push:
    branches:
      - main

name: ğŸš€ Deploy website on push

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v2.3.2

    - name: ğŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@4.0.0
      with:
        server: ftp.testenv.elementfx.com
        username: tharindu@testenv.elementfx.com
        password: Cashmate@123
        server-dir: /

    # - name: ğŸ›  Install Composer and npm
    #   run: |
    #     # Install Composer
    #     curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    #     # Install npm
    #     sudo apt-get install -y npm

    - name: ğŸ“ Create .env file
      run: |
        echo "DB_CONNECTION=mysql" >> .env
        echo "APP_NAME=Wikum" > .env
        echo "DB_HOST=127.0.0.1" >> .env
        echo "DB_PORT=3306" >> .env
        echo "DB_DATABASE=cvtrbbjr_cashmate" >> .env
        echo "DB_USERNAME=cvtrbbjr_cashmate" >> .env
        echo "DB_PASSWORD=Cashmate@123" >> .env

    - name: ğŸ›  Install PHP dependencies
      run: composer install

    - name: ğŸ” Generate App Key
      run: php artisan key:generate

    - name: ğŸ§¹ Clear Cache and Config
      run: |
        php artisan config:clear
        php artisan cache:clear

    - name: ğŸª Link Storage
      run: |
        php artisan storage:link

    - name: ğŸª Link Storage
      run: |
        run: php artisan migrate:fresh --force --seed

    # - uses: shivammathur/setup-php@v2
    #   with:
    #    php-version: '8.1'

    # - name: ğŸš§ Install Node.js and npm
    #   uses: actions/setup-node@v3
    #   with:
    #     node-version: 14

    - name: ğŸš§ Install Vite dependencies
      run: npm install

    - name: ğŸš§ Build assets with Vite
      run: npm run build
